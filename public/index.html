<!DOCTYPE HTML>
<html lang="en-us" manifest="cache.manifest">
    <head>
        <title>Comms Calendar</title>
        <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        
        <meta name="apple-mobile-web-app-title" content="Comms Calendar">
		<link rel="shortcut icon" sizes="16x16" href="images/icon16.png">
		<link rel="shortcut icon" sizes="196x196" href="images/icon196.png">
		<link rel="apple-touch-icon-precomposed" href="images/icon152.png">
		<link rel="apple-touch-startup-image" href="images/splash.png">

		<link rel="stylesheet" type="text/css" href="styles/app.css" />
		<link rel="stylesheet" type="text/css" href="styles/rating.css" />
		<script type="text/javascript" src="lib/c.js"></script>
		<script type="text/javascript" src="lib/rating.js"></script>
    </head>
    <body>
	<script defer="defer">
	var Engine = famous.core.Engine;
	var View = famous.core.View;
    var Surface = famous.core.Surface;
    var EdgeSwapper = famous.views.EdgeSwapper;
    var TabBar = famous.widgets.TabBar;
    var HeaderFooterLayout = famous.views.HeaderFooterLayout;
    var EventHandler = famous.core.EventHandler;
	var RenderNode = famous.core.RenderNode;
	var FlexScrollView = famousflex.FlexScrollView;
	var ListLayout = famousflex.layouts.ListLayout;
	var SequentialLayout = famous.views.SequentialLayout;

	var ContainerSurface = famous.surfaces.ContainerSurface;
	var InputSurface = famous.surfaces.InputSurface;
	var TextareaSurface = famous.surfaces.TextareaSurface;
	var Modifier = famous.core.Modifier;
	var Utility = famous.utilities.Utility;
	var Lightbox = famous.views.Lightbox;
	var Easing = famous.transitions.Easing;
	var Transform = famous.core.Transform;
	var GenericSync = famous.inputs.GenericSync;
	var MouseSync = famous.inputs.MouseSync;
    var TouchSync = famous.inputs.TouchSync;
	var Transitionable = famous.transitions.Transitionable;
	var Timer = famous.utilities.Timer;
	var StateModifier = famous.modifiers.StateModifier;
	var TransitionableTransform = famous.transitions.TransitionableTransform;
	var Scrollview  = famous.views.Scrollview;
	
	var searchFields = ['questions.title', 'questions.content', 'documentation.title', 'documentation.content', 'user.title', 'user.content'];
	var tabMapping = ['questions', 'documentation', 'user'];
	var layout = new HeaderFooterLayout({headerSize: 50,footerSize: 50});
	var modlayout = new HeaderFooterLayout({headerSize: 50,footerSize: 50});
	
	var search = undefined;
	var tb = undefined;
	var rc = undefined;
	var ehTab = new EventHandler();
	var usrInput = undefined;
    var tab = [];
	var modal = undefined;
	var modalTitle = undefined;
	var modalRating = undefined;
	var userInputTitle = undefined;
	var userInputContent = undefined;
	var submitState = new Modifier({});
	var submitMessages = undefined;
	var modalscrollview = undefined;
	var lightbox = undefined;
	var lbmod = undefined;
	var usrInputOpen = false;
	var usrInputFired = false;
	var questionSurface = undefined;
	var dataLoaded = false;
	var startview = undefined;
	var endview = undefined;
	var viewid = undefined;
	var geoloc = undefined;
	var remotereps = [];
	var pd = undefined;
	var mpd = undefined;
	var url = "https://355bd056-cc3e-4264-ad1b-e9c8af4db98a-bluemix:85726babe099aad16cc4abde52b4de79b93cfd08d094633cec2ab0519287ecb5@355bd056-cc3e-4264-ad1b-e9c8af4db98a-bluemix.cloudant.com/";

    var mainContext = Engine.createContext();

	
	function setCookie(e,t,n){var o=new Date;o.setDate(o.getDate()+n);var i=escape(t)+(null==n?"":";     expires="+o.toUTCString());document.cookie=e+"="+i}
	function getCookie(e){var t,n,o,i=document.cookie.split(";");for(t=0;t<i.length;t++)if(n=i[t].substr(0,i[t].indexOf("=")),o=i[t].substr(i[t].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,""),n==e)return unescape(o)}

	function _pushContentSurface(tabNo, _id, val, pos){	
		if (tab[tabNo]._dataSource){
			for (var i = 0; i < tab[tabNo]._dataSource.length; i++){
				if(tab[tabNo]._dataSource[i].attributes.id == _id){
					tab[tabNo].remove(i);
					break;
				}
			}
		}
		var mastersurface = new ContainerSurface({
			size: [undefined, 40],
			attributes : { id: _id,
			}
		});
		mastersurface.addClass('article-cell'); 
		mastersurface.on('click',function(e){ openModal(e) });
		
		var grid = new SequentialLayout({direction:0});	  
		var views = [];
		grid.sequenceFrom(views);
		
		var sizeModifier = new Modifier();
		sizeModifier.sizeFrom(function(){
			var size = mastersurface.getSize();
			return [size[0]-65 ,undefined];
		});
		  
		if (val.title.indexOf("*") == 0 || tabNo < 2){
			var image = new Surface({
			  content: '<img src="images/hq.png">',
			  size: [30, undefined]
			});
		}else{
			var image = new Surface({
			  content: '<img src="images/bullet.png">',
			  size: [30, undefined]
			});
		}
		var text = new Surface({
			properties:{
				color:'white',
				wordWrap: 'break-word'
			},
			content: val.title.replace("*","")
		});
			
		views.push(image);
		views.push(text);
		mastersurface.add(sizeModifier).add(grid);
		tab[tabNo].insert(pos, mastersurface, {size: [0, 0]}); 
	}


	function _createContentList(tabNo) {
		tab[tabNo] = new FlexScrollView({
			layout: ListLayout,
			layoutOptions: {
				margins: [5, 10, 0, 5], // margins in clockwise order: top, right, bottom, left
				spacing: 5
			},
			autoPipeEvents: true,
			useContainer: true,
			flow: true,  
			mouseMove: true,
			debug: false,					
			insertSpec: {                  
				size: [0, 0]    
			},  
			nodeSpring: {           
				dampingRatio: 0.8,  
				period: 1000        
			}
		});
    }
	function _createHelp(){
		questionSurface = new ContainerSurface({
			size: [290, 420],
			properties:{
				backgroundColor:'#008abf',
				color:'white',
				border: '3px solid white',
				overflow: 'hidden',
				zIndex: '50'
			},
			classes: ['rounded']
		});
		var grid = new SequentialLayout({direction:1});	  
		var views = [];
		grid.sequenceFrom(views);
		views.push(new Surface({
			size: [270, 110],
			properties:{
				textAlign : 'center',
			},
			classes: ['help-cell'],
			content: "Communications Market Events Calendar & Planner"
		}));
		views.push(new Surface({
			size: [270, 80],
			classes: ['help-cell'],
			content: "<div class='helpPics'><img src='./images/questions.png'></div><div style='width:200px; float:left;'>Events Calendar</div>"
		}));
		views.push(new Surface({
			size: [270, 55],
			classes: ['help-cell'],
			content: "<div class='helpPics'><img src='./images/documentation.png'></div><div style='width:200px; float:left;'>Available event modules</div>"
		}));
		views.push(new Surface({
			size: [270, 100],
			classes: ['help-cell'],
			content: "<div class='helpPics'><img src='./images/user.png'></div><div style='width:200px; float:left;'>User Feedback and Input</div>"
		}));
		views.push(new Surface({
			size: [270, 50],
			properties:{
				textAlign : 'center',
				paddingTop: '37px',
				backgroundImage: 'url("./images/swipe.png")',
				backgroundRepeat: 'no-repeat',
				backgroundPosition: 'center top',
			},
			classes: ['help-cell'],
			content: "Swipe to close this screen"
		}));
		questionSurface.add(grid);
	}

	function _addHeader() {
		var mastersurface = new ContainerSurface({
			size: [undefined, 60],
			properties:{
				margin: '7px 0px 0px 0px'
			}
		});
		
		var grid = new SequentialLayout({direction:0});	  
		var views = [];
		grid.sequenceFrom(views);
		var connectIcons = new Surface({
			content: '<img style="margin: 2px 0px 0px 4px;" id="con0" src="../images/disconnected.png"><br><img style="margin: 0px 0px 0px 4px;" id="con1" src="../images/disconnected.png">',
			size: [20, undefined]
		});
		var addContent = new Surface({
			content: '<img style="margin: 5px 5px 0px 10px;" src="images/plus.png">',
			size: [40, undefined]
		});
		addContent.on('click',function(e){ openUsrInput(e) });
		var question = new Surface({
			content: '<img style="margin: 5px 10px 0px 5px;" src="images/question.png">',
			size: [40, undefined]
		});
		question.on('click',function(e){ openQuestion() });
		
		var sizeModifier = new Modifier();
		sizeModifier.sizeFrom(function(){
			var size = mastersurface.getSize();
			return [size[0]-100 ,undefined];
		});
		var alignModifier = new Modifier({
			align: [0.5, 0.5],
			origin: [0.5, 0.5]
		});
		var down = false;
		search = new InputSurface({
			size: [undefined, 35],
			name: 'inputSurface',
			placeholder: 'Search...',
			value: '',
			type: 'text',
			classes: ['search', 'rounded']
		});	
		
		search.on('keydown', function (e) {
			if (e.which == 13 && !down) {
				down = true;			
				doSearch(e);
			}else if(e.which == 13 && down){
			} else {
				down = false;
			}
		});
		search.on("keyup", function (e) {
			down = false;
		});
		search.on("blur", function (e) {
			doSearch(e);
		});
				
		views.push(connectIcons);
		views.push(search);
		views.push(addContent);
		views.push(question);
		mastersurface.add(sizeModifier).add(grid);
		layout.header.add(mastersurface);
	}
	
	function doSearch(e){
		for (var i = 0; i < tab.length; i++){
			tab[i].removeAll();
		}
		if (search.getValue() == ''){
			_pumpList({include_docs : true}, -1);
		}
		else{
			for (var i = 0; i < tab.length; i++){
				tab[i].push(new Surface({
					size: [undefined, undefined],
					content: "<center><img src='./images/loading.gif'></center>" 
				}));
			}
			
			pd.search({
			  query: search.getValue(),
			  fields: searchFields,
			  include_docs: true
			}).then(function (res) {
				for (var i = 0; i < tab.length; i++){
					tab[i].removeAll();
				}
				mpd.post({time_stamp: new Date(), search: {search_str: search.getValue(), hit_count: res.rows.length }});
				_loadTabs(res, -1);
				
				for (var i = 0; i < tab.length; i++){
					if (tab[i]._dataSource){
						if (tab[i]._dataSource.length == 0){
							tab[i].push(new Surface({
								size: [250, 60],
								properties:{
									margin: '7px 10px 0px 10px'
								},
								content: "No search results found on this tab.<br>Check the other tabs for results" 
							}));
						}
					}else{
						tab[i].push(new Surface({
							size: [250, 60],
							properties:{
								margin: '7px 10px 0px 10px'
							},
							content: "No search results found on this tab.<br>Check the other tabs for results" 
						}));
					}
				}
			}).catch(function (err) {
			});
		}
	}
	
	function _addUserInput(){
		usrInput = new ContainerSurface({
			size: [window.innerWidth -20, window.innerHeight - 20],
			properties:{
				backgroundColor:'#008abf',
				color:'white',
				border: '3px solid white',
				padding: '2px 10px 2px 10px',
				wordWrap: 'break-word',
				zIndex: '50'
			},
			classes: ['rounded']
		});
		usrInput.lightbox = new Lightbox({
			inTransform: Transform.translate(50,-500,50),
			outTransform: Transform.translate(50,-500,50),
			inTransition: {duration:500, curve:Easing.outBounce},
			outTransition: {duration:800, curve:Easing.outElastic}
		});
		var grid = new SequentialLayout({direction:1});	  
		var views = [];
		grid.sequenceFrom(views);
		
		views.push(new Surface({
			size: [window.innerWidth -45, 25],
			properties:{
				textAlign: 'center',
				color:'white'
			},
			content: "<strong>New Entry</strong>"
		}));
		userInputTitle = new InputSurface({
			size: [window.innerWidth -45, 35],
			placeholder: "Add in an entry title here",
			classes: ['rounded', 'uinput']
		});
		views.push(userInputTitle);
		views.push(new Surface({
			size: [5, 5]
		}));
		userInputContent = new TextareaSurface({
			size: [window.innerWidth -45, window.innerHeight - 160],
			placeholder: "",
			classes: ['rounded', 'uinput']
		});

		views.push(userInputContent);
		
		var grid2 = new SequentialLayout({direction:0});	  
		var views2 = [];
		grid2.sequenceFrom(views2);
		var anode = new RenderNode(new Modifier({
			align: [1, .5],
			origin: [1, .5]
		}));

		submitMessages = new Surface({
			size: [window.innerWidth -160, 45],
			properties:{
				wordWrap: 'break-word',
				margin: '5px 5px 5px 5px',
				textAlign : 'center',
				fontSize : 'small'
			}
		});
		views2.push(submitMessages);
		views2.push(new Surface({
			size: [50, 45],
			properties:{
				margin: '7px 10px 0px 10px'
			},
			content: "<img onclick='javascript:closeUsrInput();'  src='./images/cancel.png'>" 
		}));
		views2.push(new Surface({
			size: [60, 45],
			properties:{
				margin: '7px 10px 0px 10px'
			},
			content: "<img onclick='javascript:submitUsrInput();'  src='./images/ok.png'>"
		}));			
		views.push(anode.add(grid2));
		usrInput.add(grid);
	}
	
    function _addFooter() {
        tb = new TabBar({size: [undefined, 50]});  
        tb.defineSection(0,{content: '', onClasses: ['tabbuton', 'tab1'], offClasses:['tabbutoff', 'tab1off']});
        tb.defineSection(1,{content: '', onClasses: ['tabbuton', 'tab2'], offClasses:['tabbutoff', 'tab2off']});
		tb.defineSection(2,{content: '', onClasses: ['tabbuton', 'tab3'], offClasses:['tabbutoff', 'tab3off']});
        tb.select(0);
        ehTab.subscribe(tb);
        ehTab.on('select', function(button) {
			this.rc.setOptions({
                inTransition: false,
                outTransition: false
            });
			rc.show(tab[button.id]);
		}.bind());	
		rc = new EdgeSwapper({
			overlap: false,
			inTransition: false,
			outTransition: false,
			size:[undefined, undefined]
		});
		layout.content.add(rc);	
		_createContentList(0);
		_createContentList(1);
		_createContentList(2);
		rc.show(tab[0]);
		layout.footer.add(tb);
    }
	
	function _loadTabs(res, pos){
		if (!dataLoaded){
			dataLoaded = true;
			for (var i = 0; i < tab.length; i++){
				tab[i].removeAll();
			}
		}
		for (var i = 0; i < res.rows.length; i++){
			for (var j = 0; j < tabMapping.length; j++){
				if (typeof res.rows[i].doc[tabMapping[j]] != "undefined"){
					_pushContentSurface(j, res.rows[i].id, res.rows[i].doc[tabMapping[j]], pos);
				}
			}
		} 
	}

	function _pumpList(options, pos){
		pd.allDocs(options,  function(err, res) {
			_loadTabs(res, pos);
		});
	}
	function _pumpDetailContent(id){
		var options ={
			include_docs : true,
			key : id
		};
		pd.allDocs(options,  function(err, res) {	
			Object.keys(res.rows[0].doc).forEach(function(i) {
				if (typeof res.rows[0].doc[i] === "object"){
					modalTitle.setContent("<h3>" + res.rows[0].doc[i].title.replace("*","<img src='./images/hq.png'>") + "</h3><hr width=92%>" );
					modal.setContent("<div>" + res.rows[0].doc[i].content + "</div>");
					modalRating.setContent("<hr width=92%><div>THis is the rating</div>" );
				}
			}); 
		});
	}
	
	function _BuildSearchIndex(){
		pd.search({
		  fields: searchFields,
		  build: true
		}).then(function (info) {
		}).catch(function (err) {
		});	
	}
	
	function _addModal(){
		modalscrollview = new ContainerSurface({
			size: [window.innerWidth -20, window.innerHeight - 20],
			properties:{
				backgroundColor:'#008abf',
				color:'white',
				border: '3px solid white',
				overflow: 'hidden',
				zIndex: '50'
			},
			classes: ['rounded']
		});
		modalscrollview.contentscroll = new FlexScrollView({
			layout: ListLayout,
			layoutOptions: {
				isSectionCallback: function(renderNode) {
					return renderNode.isSection;
				},
				margins: [1, 5, 0, 5], 
				spacing: 5
			},
			dataSource: [
				_createSection(),
				
				 new Surface({})
			],
			autoPipeEvents: true,
			useContainer: false,
			flow: true,  
			mouseMove: true,
			debug: false,					
			nodeSpring: {           
				dampingRatio: 0.8,  
				period: 1000        
			}
		});

		var grid = new SequentialLayout({direction:1});	  
		var views = [];
		grid.sequenceFrom(views);
		views.push(_createTitle());
		views.push(modalscrollview.contentscroll);
		views.push(_createRating());
\
		modalscrollview.add(grid);
	}
	function _createTitle(mcontent) {
		modalTitle = new Surface({
			size: [undefined, 60],
			properties:{
				backgroundColor:'#008abf',
				color:'white',
				textAlign: 'center',
				zIndex: '51',
			},
		});
		return modalTitle;
	}
	
	function _createSection() {
	    modal = new Surface({
			size: [undefined, 5000],
			properties:{
				wordWrap: 'break-word'
			}
		});
	  return modal;
	}

	function _createRating(mcontent) {
	    modalRating = new Surface({
			size: [undefined, 60],
			properties:{
				backgroundColor:'#008abf',
				color:'white',
				textAlign: 'center',
				zIndex: '51',
			},
		});
		return modalRating;
	}
	
	function openModal(e){
		_pumpDetailContent(e.currentTarget.id);
		modalscrollview.contentscroll.goToFirstPage();    
		viewid = e.currentTarget.id;
		startview = Date.now();
		lightbox.show(modalscrollview);
	}
	
	function openUsrInput(e){
		if (!usrInputOpen){
			usrInputOpen = true;
			usrInput.lightbox.show(usrInput);
			navigator.geolocation.getCurrentPosition(getGeoLoc);
		}
	}
	
	function openQuestion(){
		if (!usrInputOpen){
			usrInputOpen = true;
			lightbox.show(questionSurface);
		}
	}
	
	function closeUsrInput(){
		userInputTitle.setValue("");
		userInputContent.setValue("");
		usrInputOpen = false;
		usrInput.lightbox.hide();
		submitMessages.setContent("");
	}
	function closeLightbox(){
		if(viewid){
			mpd.post({time_stamp: new Date(), docview: {doc_id : viewid, time: Date.now() - startview}});
			viewid = undefined;
			startview = undefined;
		}
		usrInputOpen = false;
		lightbox.hide();
	}
	
	function _createLightbox(){
		lightbox = new Lightbox({
			inTransform: Transform.translate(-500,0,500),
			outTransform: Transform.translate(-500,0,500),
			inTransition: {duration:800, curve:Easing.outElastic},
			outTransition: {duration:800, curve:Easing.outElastic}
		});
  
		var currentPos = new Transitionable([0, 0]);  			
		lbmod = new Modifier({
			transform: function () {
				var pos = currentPos.get();
				return Transform.translate(pos[0], pos[1], 50);
			}
		});

		modalscrollview.pipe(getLbSync(currentPos)); 
		questionSurface.pipe(getLbSync(currentPos)); 
	}
	function getLbSync(currentPos){
		var origpos = currentPos.get(); 
		GenericSync.register({'mouse': MouseSync, 'touch': TouchSync});
		var lbsync = new GenericSync(['mouse', 'touch']);
		lbsync.on('update', function (data) {
			var pos = currentPos.get();
			if (Math.abs(data.velocity[0]) > .5){
				currentPos.set([pos[0] + data.delta[0], pos[1]]);
			}
		});
		lbsync.on('end', function (data) {
			var velocity = Math.abs(data.velocity[0]);
			currentPos.set(origpos);
			if (velocity > .7) {
				closeLightbox();
			}     
		});
		return lbsync;
	}
	function getGeoLoc(position) {
		geoloc =  position.coords.latitude + "," + position.coords.longitude; 
	}
	function submitUsrInput(e){
		if (userInputTitle.getValue().length>2 && userInputContent.getValue().length>2){
			var docid = userInputTitle.getValue().replace(/[^a-z0-9]/gi, '') + "_" + Date.now();
			var d = new Date();

			var doc = {
			  "_id": docid,
			  "user": {
				"title": userInputTitle.getValue().replace(/[^a-z0-9\s]/gi, ' ').replace(/  /g, ' ').replace(/  /g, ' ').trim(),
				"content": userInputContent.getValue().trim(),
				"geoloc": geoloc,
				"timestamp": new Date(d.getTime() - d.getTimezoneOffset() * 60000).toJSON().slice(0, 16).replace("T", " ") + "U",
				"epoch": new Date().getTime() - 7200000
			  }
			};
			pd.put(doc).then(function (response) {
				closeUsrInput();
				_pumpList({include_docs : true,	key : docid}, 0);
				tb.select(2);
			}).catch(function (err) {
				submitMessages.setContent("Whoops! " + err.message);
			});
		}
		else{
			submitMessages.setContent("Inputs must be longer.");
		}
	}
	
	

	_addHeader();
    _addFooter();	
	_addUserInput();
	_addModal();
	_createHelp();
	_createLightbox();
	
	pd = new PouchDB('battle', {auto_compaction: true, size: 50});
	mpd = new PouchDB('a_metrics', {auto_compaction: true});
	
	
	mainContext.add(layout);	
	mainContext.add(new Modifier({origin:[0.5,0.5]})).add(lbmod).add(lightbox);	
	mainContext.add(new Modifier({origin:[0.5,0.5]})).add(usrInput.lightbox);
	
	pd.info().then(function (result) {
		if (result.doc_count >0 ){
			var options ={
				include_docs : true
			};
			_pumpList(options, -1);
		}else{
			for (var i = 0; i < tab.length; i++){
				tab[i].push(new Surface({
					size: [undefined, undefined],
					content: "<br><br><center><img src='./images/loading.gif'></center>" 
				}));
			}
		}
	}).catch(function (err) {
	  console.log(err);
	});
	
	
	remotereps[0] = new PouchDB(url + 'battle', {skip_setup: true, ajax: {timeout: 20000}});
	remotereps[1] = new PouchDB('http://10.0.1.2:5984/battle', {ajax: {timeout: 20000}});
	var rdbs = [0,1];

	rdbs.map(function (index){
		return pd.sync(remotereps[index], {live: true, retry: true, since: 0, back_off_function: function (delay) {return 10000;}}
		).on('error', function (err) {
		document.getElementById("con" + index).src = "../images/disconnected.png";
	}).on('change', function(info) {
		Promise.all(info.change.docs.map(function (i) {
	    if (i._deleted) {
			try{
				for (var j = 0; j < tab.length; j++){
					for (var k = 0; k < tab[j]._dataSource.length; k++){
						if(tab[j]._dataSource[k].attributes.id == i._id){
							return tab[j].remove(k);
						}
					}
				}
			}catch(fail){}
		} else { 
			_BuildSearchIndex();
			var options ={
				include_docs : true,
				key : i._id
			};
			return _pumpList(options, 0);
		}
		})).catch(console.log.bind(console));
	}).on('paused', function (info) {
		document.getElementById("con" + index).src = "../images/disconnected.png";
	}).on('active', function (info) {
		document.getElementById("con" + index).src = "../images/connected.png";
	}).catch(console.log.bind(console));
	});

	mpd.replicate.to(url + 'a_metrics', {live: true, retry: true});	


	if(!getCookie('commsCalendar')){
		setCookie('commsCalendar','visited',20*365);
		setTimeout( openQuestion(), 1300 );
	}
	</script>
	</body>
</html>
