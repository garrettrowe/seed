<!DOCTYPE HTML>
<html lang="en-us" manifest="cache.manifest">
    <head>
        <title>IIS BattleCard</title>
        <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        
        <meta name="apple-mobile-web-app-title" content="Comms Calendar">
		<link rel="shortcut icon" sizes="16x16" href="images/icon16.png">
		<link rel="shortcut icon" sizes="196x196" href="images/icon196.png">
		<link rel="apple-touch-icon-precomposed" href="images/icon152.png">
		<link rel="apple-touch-startup-image" href="images/splash.png">

		<link rel="stylesheet" type="text/css" href="styles/app.css" />
		<script type="text/javascript" src="lib/uncompressed.js"></script>
    </head>
    <body>
	<script defer="defer">
	function setCookie(e,t,n){var o=new Date;o.setDate(o.getDate()+n);var i=escape(t)+(null==n?"":";     expires="+o.toUTCString());document.cookie=e+"="+i}function getCookie(e){var t,n,o,i=document.cookie.split(";");for(t=0;t<i.length;t++)if(n=i[t].substr(0,i[t].indexOf("=")),o=i[t].substr(i[t].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,""),n==e)return unescape(o)}function _pushContentSurface(e,t,n,o){if(tab[e]._dataSource)for(var i=0;i<tab[e]._dataSource.length;i++)if(tab[e]._dataSource[i].attributes.id==t){tab[e].remove(i);break}var a=new ContainerSurface({size:[void 0,40],attributes:{id:t}});a.addClass("article-cell"),a.on("click",function(e){openModal(e)});var r=new SequentialLayout({direction:0}),s=[];r.sequenceFrom(s);var c=new Modifier;if(c.sizeFrom(function(){var e=a.getSize();return[e[0]-65,void 0]}),0==n.title.indexOf("*")||2>e)var u=new Surface({content:'<img src="images/hq.png">',size:[30,void 0]});else var u=new Surface({content:'<img src="images/bullet.png">',size:[30,void 0]});var d=new Surface({properties:{color:"white",wordWrap:"break-word"},content:n.title.replace("*","")});s.push(u),s.push(d),a.add(c).add(r),tab[e].insert(o,a,{size:[0,0]})}function _createContentList(e){tab[e]=new FlexScrollView({layout:ListLayout,layoutOptions:{margins:[5,10,0,5],spacing:5},autoPipeEvents:!0,useContainer:!0,flow:!0,mouseMove:!0,debug:!1,insertSpec:{size:[0,0]},nodeSpring:{dampingRatio:.8,period:1e3}})}function _createHelp(){questionSurface=new ContainerSurface({size:[290,420],properties:{backgroundColor:"#008abf",color:"white",border:"3px solid white",overflow:"hidden",zIndex:"50"},classes:["rounded"]});var e=new SequentialLayout({direction:1}),t=[];e.sequenceFrom(t),t.push(new Surface({size:[270,110],properties:{textAlign:"center"},classes:["help-cell"],content:"This application is designed to bring you mission and area intel, and allow for mission reports.  Information will be automatically synced when online."})),t.push(new Surface({size:[270,80],classes:["help-cell"],content:"<div class='helpPics'><img src='./images/questions.png'></div><div style='width:200px; float:left;'>This tab features mission information and directives</div>"})),t.push(new Surface({size:[270,55],classes:["help-cell"],content:"<div class='helpPics'><img src='./images/documentation.png'></div><div style='width:200px; float:left;'>This tab features area intel, daily briefings and weather</div>"})),t.push(new Surface({size:[270,100],classes:["help-cell"],content:"<div class='helpPics'><img src='./images/user.png'></div><div style='width:200px; float:left;'>This tab features mission reports.  Click on the plus arrow in the top right of the screen to add a new report.</div>"})),t.push(new Surface({size:[270,50],properties:{textAlign:"center",paddingTop:"37px",backgroundImage:'url("./images/swipe.png")',backgroundRepeat:"no-repeat",backgroundPosition:"center top"},classes:["help-cell"],content:"Swipe to close this screen"})),questionSurface.add(e)}function _addHeader(){var e=new ContainerSurface({size:[void 0,60],properties:{margin:"7px 0px 0px 0px"}}),t=new SequentialLayout({direction:0}),n=[];t.sequenceFrom(n);var o=new Surface({content:'<img style="margin: 2px 0px 0px 4px;" id="con0" src="../images/disconnected.png"><br><img style="margin: 0px 0px 0px 4px;" id="con1" src="../images/disconnected.png">',size:[20,void 0]}),i=new Surface({content:'<img style="margin: 5px 5px 0px 10px;" src="images/plus.png">',size:[40,void 0]});i.on("click",function(e){openUsrInput(e)});var a=new Surface({content:'<img style="margin: 5px 10px 0px 5px;" src="images/question.png">',size:[40,void 0]});a.on("click",function(e){openQuestion()});var r=new Modifier;r.sizeFrom(function(){var t=e.getSize();return[t[0]-100,void 0]});var s=(new Modifier({align:[.5,.5],origin:[.5,.5]}),!1);search=new InputSurface({size:[void 0,35],name:"inputSurface",placeholder:"Search...",value:"",type:"text",classes:["search","rounded"]}),search.on("keydown",function(e){13!=e.which||s?13==e.which&&s||(s=!1):(s=!0,doSearch(e))}),search.on("keyup",function(e){s=!1}),search.on("blur",function(e){doSearch(e)}),n.push(o),n.push(search),n.push(i),n.push(a),e.add(r).add(t),layout.header.add(e)}function doSearch(e){for(var t=0;t<tab.length;t++)tab[t].removeAll();if(""==search.getValue())_pumpList({include_docs:!0},-1);else{for(var t=0;t<tab.length;t++)tab[t].push(new Surface({size:[void 0,void 0],content:"<center><img src='./images/loading.gif'></center>"}));pd.search({query:search.getValue(),fields:searchFields,include_docs:!0}).then(function(e){for(var t=0;t<tab.length;t++)tab[t].removeAll();mpd.post({time_stamp:new Date,search:{search_str:search.getValue(),hit_count:e.rows.length}}),_loadTabs(e,-1);for(var t=0;t<tab.length;t++)tab[t]._dataSource?0==tab[t]._dataSource.length&&tab[t].push(new Surface({size:[250,60],properties:{margin:"7px 10px 0px 10px"},content:"No search results found on this tab.<br>Check the other tabs for results"})):tab[t].push(new Surface({size:[250,60],properties:{margin:"7px 10px 0px 10px"},content:"No search results found on this tab.<br>Check the other tabs for results"}))})["catch"](function(e){})}}function _addUserInput(){usrInput=new ContainerSurface({size:[window.innerWidth-20,window.innerHeight-20],properties:{backgroundColor:"#008abf",color:"white",border:"3px solid white",padding:"2px 10px 2px 10px",wordWrap:"break-word",zIndex:"50"},classes:["rounded"]}),usrInput.lightbox=new Lightbox({inTransform:Transform.translate(50,-500,50),outTransform:Transform.translate(50,-500,50),inTransition:{duration:500,curve:Easing.outBounce},outTransition:{duration:800,curve:Easing.outElastic}});var e=new SequentialLayout({direction:1}),t=[];e.sequenceFrom(t),t.push(new Surface({size:[window.innerWidth-45,25],properties:{textAlign:"center",color:"white"},content:"<strong>New Mission Report</strong>"})),userInputTitle=new InputSurface({size:[window.innerWidth-45,35],placeholder:"Add in an entry title here",classes:["rounded","uinput"]}),t.push(userInputTitle),t.push(new Surface({size:[5,5]})),userInputContent=new TextareaSurface({size:[window.innerWidth-45,window.innerHeight-160],placeholder:"Add your mission report here",classes:["rounded","uinput"]}),t.push(userInputContent);var n=new SequentialLayout({direction:0}),o=[];n.sequenceFrom(o);var i=new RenderNode(new Modifier({align:[1,.5],origin:[1,.5]}));submitMessages=new Surface({size:[window.innerWidth-160,45],properties:{wordWrap:"break-word",margin:"5px 5px 5px 5px",textAlign:"center",fontSize:"small"}}),o.push(submitMessages),o.push(new Surface({size:[50,45],properties:{margin:"7px 10px 0px 10px"},content:"<img onclick='javascript:closeUsrInput();'  src='./images/cancel.png'>"})),o.push(new Surface({size:[60,45],properties:{margin:"7px 10px 0px 10px"},content:"<img onclick='javascript:submitUsrInput();'  src='./images/ok.png'>"})),t.push(i.add(n)),usrInput.add(e)}function _addFooter(){tb=new TabBar({size:[void 0,50]}),tb.defineSection(0,{content:"",onClasses:["tabbuton","tab1"],offClasses:["tabbutoff","tab1off"]}),tb.defineSection(1,{content:"",onClasses:["tabbuton","tab2"],offClasses:["tabbutoff","tab2off"]}),tb.defineSection(2,{content:"",onClasses:["tabbuton","tab3"],offClasses:["tabbutoff","tab3off"]}),tb.select(0),ehTab.subscribe(tb),ehTab.on("select",function(e){this.rc.setOptions({inTransition:!1,outTransition:!1}),rc.show(tab[e.id])}.bind()),rc=new EdgeSwapper({overlap:!1,inTransition:!1,outTransition:!1,size:[void 0,void 0]}),layout.content.add(rc),_createContentList(0),_createContentList(1),_createContentList(2),rc.show(tab[0]),layout.footer.add(tb)}function _loadTabs(e,t){if(!dataLoaded){dataLoaded=!0;for(var n=0;n<tab.length;n++)tab[n].removeAll()}for(var n=0;n<e.rows.length;n++)for(var o=0;o<tabMapping.length;o++)"undefined"!=typeof e.rows[n].doc[tabMapping[o]]&&_pushContentSurface(o,e.rows[n].id,e.rows[n].doc[tabMapping[o]],t)}function _pumpList(e,t){pd.allDocs(e,function(e,n){_loadTabs(n,t)})}function _pumpDetailContent(e){var t={include_docs:!0,key:e};pd.allDocs(t,function(e,t){Object.keys(t.rows[0].doc).forEach(function(e){"object"==typeof t.rows[0].doc[e]&&(modalTitle.setContent("<h3>"+t.rows[0].doc[e].title.replace("*","<img src='./images/hq.png'>")+"</h3><hr width=92%>"),modal.setContent("<div>"+t.rows[0].doc[e].content+"</div>"))})})}function _BuildSearchIndex(){pd.search({fields:searchFields,build:!0}).then(function(e){})["catch"](function(e){})}function _addModal(){modalscrollview=new ContainerSurface({size:[window.innerWidth-20,window.innerHeight-20],properties:{backgroundColor:"#008abf",color:"white",border:"3px solid white",overflow:"hidden",zIndex:"50"},classes:["rounded"]}),modalscrollview.contentscroll=new FlexScrollView({layout:ListLayout,layoutOptions:{isSectionCallback:function(e){return e.isSection},margins:[1,5,0,5],spacing:5},dataSource:[_createTitle(),_createSection(),new Surface({})],autoPipeEvents:!0,useContainer:!1,flow:!0,mouseMove:!0,debug:!1,nodeSpring:{dampingRatio:.8,period:1e3}}),modalscrollview.add(modalscrollview.contentscroll)}function _createTitle(){modalTitle=new Surface({size:[void 0,60],properties:{backgroundColor:"#008abf",color:"white",textAlign:"center",zIndex:"51"}});var e=new RenderNode(new Modifier({transform:Transform.infront}));return e.add(modalTitle),e}function _createSection(){return modal=new Surface({size:[void 0,5e3],properties:{wordWrap:"break-word"}})}function openModal(e){_pumpDetailContent(e.currentTarget.id),modalscrollview.contentscroll.goToFirstPage(),viewid=e.currentTarget.id,startview=Date.now(),lightbox.show(modalscrollview)}function openUsrInput(e){usrInputOpen||(usrInputOpen=!0,usrInput.lightbox.show(usrInput),navigator.geolocation.getCurrentPosition(getGeoLoc))}function openQuestion(){usrInputOpen||(usrInputOpen=!0,lightbox.show(questionSurface))}function closeUsrInput(){userInputTitle.setValue(""),userInputContent.setValue(""),usrInputOpen=!1,usrInput.lightbox.hide(),submitMessages.setContent("")}function closeLightbox(){viewid&&(mpd.post({time_stamp:new Date,docview:{doc_id:viewid,time:Date.now()-startview}}),viewid=void 0,startview=void 0),usrInputOpen=!1,lightbox.hide()}function _createLightbox(){lightbox=new Lightbox({inTransform:Transform.translate(-500,0,500),outTransform:Transform.translate(-500,0,500),inTransition:{duration:800,curve:Easing.outElastic},outTransition:{duration:800,curve:Easing.outElastic}});var e=new Transitionable([0,0]);lbmod=new Modifier({transform:function(){var t=e.get();return Transform.translate(t[0],t[1],50)}}),modalscrollview.pipe(getLbSync(e)),questionSurface.pipe(getLbSync(e))}function getLbSync(e){var t=e.get();GenericSync.register({mouse:MouseSync,touch:TouchSync});var n=new GenericSync(["mouse","touch"]);return n.on("update",function(t){var n=e.get();Math.abs(t.velocity[0])>.5&&e.set([n[0]+t.delta[0],n[1]])}),n.on("end",function(n){var o=Math.abs(n.velocity[0]);e.set(t),o>.7&&closeLightbox()}),n}function getGeoLoc(e){geoloc=e.coords.latitude+","+e.coords.longitude}function submitUsrInput(e){if(userInputTitle.getValue().length>5&&userInputContent.getValue().length>5){var t=userInputTitle.getValue().replace(/[^a-z0-9]/gi,"")+"_"+Date.now(),n=new Date,o={_id:t,user:{title:userInputTitle.getValue().replace(/[^a-z0-9\s]/gi," ").replace(/  /g," ").replace(/  /g," ").trim(),content:userInputContent.getValue().trim(),geoloc:geoloc,timestamp:new Date(n.getTime()-6e4*n.getTimezoneOffset()).toJSON().slice(0,16).replace("T"," ")+"U",epoch:(new Date).getTime()-72e5}};pd.put(o).then(function(e){closeUsrInput(),_pumpList({include_docs:!0,key:t},0),tb.select(2)})["catch"](function(e){submitMessages.setContent("Whoops! "+e.message)})}else submitMessages.setContent("Mission reports are required to be longer.")}var Engine=famous.core.Engine,View=famous.core.View,Surface=famous.core.Surface,EdgeSwapper=famous.views.EdgeSwapper,TabBar=famous.widgets.TabBar,HeaderFooterLayout=famous.views.HeaderFooterLayout,EventHandler=famous.core.EventHandler,RenderNode=famous.core.RenderNode,FlexScrollView=famousflex.FlexScrollView,ListLayout=famousflex.layouts.ListLayout,SequentialLayout=famous.views.SequentialLayout,ContainerSurface=famous.surfaces.ContainerSurface,InputSurface=famous.surfaces.InputSurface,TextareaSurface=famous.surfaces.TextareaSurface,Modifier=famous.core.Modifier,Utility=famous.utilities.Utility,Lightbox=famous.views.Lightbox,Easing=famous.transitions.Easing,Transform=famous.core.Transform,GenericSync=famous.inputs.GenericSync,MouseSync=famous.inputs.MouseSync,TouchSync=famous.inputs.TouchSync,Transitionable=famous.transitions.Transitionable,Timer=famous.utilities.Timer,StateModifier=famous.modifiers.StateModifier,TransitionableTransform=famous.transitions.TransitionableTransform,Scrollview=famous.views.Scrollview,searchFields=["questions.title","questions.content","documentation.title","documentation.content","user.title","user.content"],tabMapping=["questions","documentation","user"],layout=new HeaderFooterLayout({headerSize:50,footerSize:50}),search=void 0,tb=void 0,rc=void 0,ehTab=new EventHandler,usrInput=void 0,tab=[],modal=void 0,modalTitle=void 0,userInputTitle=void 0,userInputContent=void 0,submitState=new Modifier({}),submitMessages=void 0,modalscrollview=void 0,lightbox=void 0,lbmod=void 0,usrInputOpen=!1,usrInputFired=!1,questionSurface=void 0,dataLoaded=!1,startview=void 0,endview=void 0,viewid=void 0,geoloc=void 0,remotereps=[],pd=void 0,mpd=void 0,url="https://4a47de8f-7101-4695-83d2-6d2fc9be0a97-bluemix:cd8497f0c88b161e3ee87892ec67627d4c82336a9a4545bbc03710d9b1f5cf07@4a47de8f-7101-4695-83d2-6d2fc9be0a97-bluemix.cloudant.com/",mainContext=Engine.createContext();_addHeader(),_addFooter(),_addUserInput(),_addModal(),_createHelp(),_createLightbox(),pd=new PouchDB("battle",{auto_compaction:!0,size:50}),mpd=new PouchDB("a_metrics",{auto_compaction:!0}),mainContext.add(layout),mainContext.add(new Modifier({origin:[.5,.5]})).add(lbmod).add(lightbox),mainContext.add(new Modifier({origin:[.5,.5]})).add(usrInput.lightbox),pd.info().then(function(e){if(e.doc_count>0){var t={include_docs:!0};_pumpList(t,-1)}else for(var n=0;n<tab.length;n++)tab[n].push(new Surface({size:[void 0,void 0],content:"<br><br><center><img src='./images/loading.gif'></center>"}))})["catch"](function(e){console.log(e)}),remotereps[0]=new PouchDB(url+"battle",{skip_setup:!0,ajax:{timeout:2e4}}),remotereps[1]=new PouchDB("http://10.0.1.2:5984/battle",{ajax:{timeout:2e4}});var rdbs=[0,1];rdbs.map(function(e){return pd.sync(remotereps[e],{live:!0,retry:!0,since:0,back_off_function:function(e){return 1e4}}).on("error",function(t){document.getElementById("con"+e).src="../images/disconnected.png"}).on("change",function(e){Promise.all(e.change.docs.map(function(e){if(!e._deleted){_BuildSearchIndex();var t={include_docs:!0,key:e._id};return _pumpList(t,0)}try{for(var n=0;n<tab.length;n++)for(var o=0;o<tab[n]._dataSource.length;o++)if(tab[n]._dataSource[o].attributes.id==e._id)return tab[n].remove(o)}catch(i){}}))["catch"](console.log.bind(console))}).on("paused",function(t){document.getElementById("con"+e).src="../images/disconnected.png"}).on("active",function(t){document.getElementById("con"+e).src="../images/connected.png"})["catch"](console.log.bind(console))}),mpd.replicate.to(url+"a_metrics",{live:!0,retry:!0}),getCookie("IISBattleCard")||(setCookie("IISBattleCard","visited",7300),setTimeout(openQuestion(),1300));
	</script>
	</body>
</html>
